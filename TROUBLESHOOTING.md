# Устранение неполадок Trailer-Go

## Проблемы с авторизацией

### 1. Тестовая авторизация не работает

**Симптомы:**
- Кнопка "Войти через Telegram" не работает
- Ошибка "Ошибка подключения к серверу"

**Решение:**
1. Убедитесь, что backend сервер запущен на порту 8080
2. Проверьте файл `server/.env`:
   ```env
   ALLOW_DEV_AUTH=true
   JWT_SECRET=your_super_secret_jwt_key_here
   ```
3. Проверьте консоль браузера на ошибки CORS
4. Убедитесь, что в `web/vite.config.ts` настроен proxy:
   ```typescript
   proxy: {
     '/api': {
       target: 'http://localhost:8080',
       changeOrigin: true,
     },
   }
   ```

### 2. Ошибка "Telegram WebApp не доступен"

**Симптомы:**
- Сообщение об ошибке при попытке авторизации

**Решение:**
- Это нормально в режиме разработки
- Приложение автоматически переключится на dev-режим
- Убедитесь, что `ALLOW_DEV_AUTH=true` в `.env`

## Проблемы с черным экраном

### 1. Черный экран при выборе времени аренды

**Симптомы:**
- Страница прицепа загружается, но при выборе времени появляется черный экран
- Приложение "вылетает" при изменении полей формы

**Решение:**
1. **Используйте тестовую страницу** для проверки:
   - Откройте `http://localhost:5173/test`
   - Проверьте работу форм без вылетов

2. Откройте консоль браузера (F12)
3. Проверьте ошибки JavaScript
4. Убедитесь, что все поля формы заполнены:
   - Дата начала
   - Время начала
   - Продолжительность > 0

5. **Быстрый тест:**
   ```bash
   # Запустите тестовую среду
   test-app.bat
   
   # Или тест исправлений
   test-fix.bat
   
   # Или полный тест с API проверкой
   test-fix-v2.bat
   
   # Или тест полного flow бронирования
   test-booking.bat
   ```

### 3. Ошибка "Cannot read properties of undefined (reading 'rental')"

**Симптомы:**
- Ошибка в консоли при выборе даты/времени
- Приложение вылетает при расчете стоимости

**Решение:**
1. **Проверьте структуру ответа API:**
   - Откройте Network tab в DevTools
   - Проверьте ответ от `/api/quote`
   - Убедитесь, что `pricing.breakdown.rental` присутствует

2. **Используйте Error Boundary:**
   - Приложение теперь имеет защиту от ошибок
   - Ошибки будут показаны в понятном виде

3. **Проверьте логи сервера:**
   - Убедитесь, что backend возвращает правильную структуру
   - Проверьте, что `calculatePricing` работает корректно

4. **Используйте API тест:**
   - Откройте `test-api.html` в браузере
   - Проверьте структуру ответа от `/api/quote`
   - Убедитесь, что `pricing.breakdown` присутствует

### 4. Проблемы с бронированием

**Симптомы:**
- После нажатия "Забронировать" ничего не происходит
- Страница `/booking` не найдена
- Ошибка при создании бронирования

**Решение:**
1. **Проверьте авторизацию:**
   - Убедитесь, что вы авторизованы
   - Проверьте наличие токена в localStorage

2. **Проверьте данные формы:**
   - Все поля должны быть заполнены
   - Дата не должна быть в прошлом
   - Продолжительность должна быть больше 0

3. **Проверьте API:**
   - Убедитесь, что backend отвечает на `/api/bookings`
   - Проверьте логи сервера на ошибки

4. **Используйте полный тест:**
   ```bash
   test-booking.bat
   ```

### 2. Ошибки в консоли

**Частые ошибки:**
- `Failed to fetch` - проблема с подключением к API
- `CORS error` - проблема с настройками CORS
- `TypeError: Cannot read property` - ошибка в коде

**Решение:**
1. Проверьте, что backend сервер запущен
2. Проверьте URL API в `web/src/api.ts`
3. Убедитесь, что все зависимости установлены

## Проблемы с сервером

### 1. Сервер не запускается

**Симптомы:**
- Ошибка при запуске `npm run dev`
- Порт 8080 занят

**Решение:**
```bash
# Проверьте, что порт свободен
netstat -an | findstr :8080

# Если порт занят, измените PORT в .env
PORT=8081
```

### 2. Ошибки TypeScript

**Симптомы:**
- Ошибки компиляции TypeScript

**Решение:**
```bash
# Переустановите зависимости
cd server
rm -rf node_modules package-lock.json
npm install

cd ../web
rm -rf node_modules package-lock.json
npm install
```

## Проблемы с данными

### 1. Прицепы не загружаются

**Симптомы:**
- Пустая страница с прицепами
- Ошибка "Прицепы не найдены"

**Решение:**
1. Проверьте API endpoint: `GET http://localhost:8080/api/trailers`
2. Убедитесь, что данные инициализированы в `server/src/data.ts`
3. Проверьте логи сервера

### 2. Расчет стоимости не работает

**Симптомы:**
- Кнопка "Забронировать" неактивна
- Нет расчета стоимости

**Решение:**
1. Заполните все поля формы:
   - Дата начала (не в прошлом)
   - Время начала
   - Продолжительность (минимум 2 часа для почасовой)
2. Проверьте консоль на ошибки API
3. Убедитесь, что backend отвечает на `/api/quote`

## Проблемы с окружением

### 1. Переменные окружения

**Проверьте файл `server/.env`:**
```env
BOT_TOKEN=your_telegram_bot_token_here
JWT_SECRET=your_super_secret_jwt_key_here
ALLOW_DEV_AUTH=true
NODE_ENV=development
PORT=8080
```

### 2. Версии Node.js

**Требования:**
- Node.js 18+
- npm 8+

**Проверка:**
```bash
node --version
npm --version
```

## Быстрые решения

### 1. Полный перезапуск

```bash
# Остановите все процессы
# Удалите node_modules
rm -rf server/node_modules web/node_modules

# Переустановите зависимости
cd server && npm install && cd ..
cd web && npm install && cd ..

# Запустите заново
cd server && npm run dev &
cd web && npm run dev &
```

### 2. Очистка кэша

```bash
# Очистите npm кэш
npm cache clean --force

# Очистите кэш браузера
# Chrome: Ctrl+Shift+Delete
# Firefox: Ctrl+Shift+Delete
```

### 3. Проверка портов

```bash
# Windows
netstat -an | findstr :8080
netstat -an | findstr :5173

# Linux/Mac
lsof -i :8080
lsof -i :5173
```

## Логи и отладка

### 1. Включение подробных логов

В `server/src/index.ts` добавьте:
```typescript
console.log('Request:', req.method, req.url, req.body);
```

### 2. Проверка API

```bash
# Health check
curl http://localhost:8080/api/health

# Тестовая авторизация
curl -X POST http://localhost:8080/api/auth/dev \
  -H "Content-Type: application/json" \
  -d '{"userId":"test-user"}'

# Список прицепов
curl http://localhost:8080/api/trailers
```

### 3. Консоль браузера

Откройте DevTools (F12) и проверьте:
- Console - ошибки JavaScript
- Network - запросы к API
- Application - localStorage, sessionStorage

## Контакты

Если проблемы не решаются:
1. Проверьте логи сервера и браузера
2. Убедитесь, что все зависимости установлены
3. Проверьте версии Node.js и npm
4. Создайте issue с подробным описанием проблемы
