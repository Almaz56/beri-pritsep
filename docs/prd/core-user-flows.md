# Core User Flows

## 1. QR-сканирование и навигация

### 1.1 QR локации → Каталог прицепов

**Триггер:** Пользователь сканирует QR-код на локации (автопарк прицепов)

**Акторы:** Клиент, Система

**Предусловия:**
- QR-код содержит корректную ссылку на локацию
- У пользователя есть доступ к сканеру QR
- Telegram Mini App корректно инициализирован

**Основной поток:**
1. Клиент сканирует QR-код локации
2. Система определяет ID локации из QR
3. Переход в Telegram Mini App
4. Система загружает каталог прицепов данной локации
5. Показ отфильтрованного каталога с прицепами доступной локации
6. Клиент просматривает доступные прицепы

**Альтернативные потоки:**
- **3a** QR-код повреждён или неработает → показ общей ошибки и предложение ввести ID локации вручную
- **4a** Нет доступных прицепов в локации → показ пустого состояния с ожидаемой датой пополнения
- **6a** Нужна другая локация → переход к поиску по карте города

**Постусловия:**
- Клиент видит каталог прицепов конкретной локации
- Система запоминает выбор локации для дальнейшего бронирования

### 1.2 QR прицепа → Карточка прицепа

**Триггер:** Пользователь сканирует QR-код на конкретном прицепе

**Акторы:** Клиент, Система

**Предусловия:**
- QR-код содержит корректную ссылку на прицеп
- Прицеп доступен для аренды
- Пользователь авторизован в системе

**Основной поток:**
1. Клиент сканирует QR-код прицепа
2. Система определяет ID прицепа из QR
3. Переход в Telegram Mini App
4. Система загружает детальную информацию о прицепе
5. Показ карточки прицепа с характеристиками и фотографиями
6. Клиент просматривает детали и доступность времён
7. Предложение забронировать прицеп или изучить альтернативы

**Альтернативные потоки:**
- **3a** QR-код повреждён → показ общей ошибки и предложение найти прицеп в каталоге
- **4a** Прицеп недоступен → показ статуса "занят" с ожидаемой датой освобождения
- **7a** Нужен другой прицеп → переход к каталогу всей локации

**Постусловия:**
- Клиент видит детальную информацию о конкретном прицепе
- Система готова к процессу бронирования или поиска альтернатив

## 2. Авторизация пользователей

### 2.1 Telegram initData авторизация

**Триггер:** Пользователь впервые открывает приложение

**Акторы:** Клиент, Telegram WebApp API, Система

**Предусловия:**
- Пользователь находится в Telegram
- Telegram WebApp API доступен
- Пользователь согласен с передачей базовых данных

**Основной поток:**
1. Пользователь открывает Telegram Mini App
2. Telegram WebApp предоставляет initData с базовой информацией
3. Система проверяет подлинность initData через HMAC
4. Система извлекает: Telegram ID, имя, username (если есть)
5. Проверка наличия пользователя в базе данных по Telegram ID
6. **Если пользователь новый:**
   - Создание записи пользователя
   - Статус верификации: "PENDING"
   - Статус верификации телефона: "REQUIRED"
7. **Если пользователь существующий:**
   - Обновление данных профиля из Telegram
   - Сохранение текущих статусов верификации
8. Генерация JWT токена для авторизации
9. Переход к главному экрану приложения

**Альтернативные потоки:**
- **3a** InitData не прошёл проверку подлинности → ошибка авторизации и запрос повторной попытки
- **6a** Ошибка создания пользователя → техническая поддержка и процедура восстановления
- **9a** Требуется верификация телефона → директный переход на экран запроса телефона

**Постусловия:**
- Пользователь авторизован в системе
- Создан или обновлён профиль пользователя
- Система готова к следующим шагам верификации

### 2.2 Запрос телефона через Telegram чат

**Триггер:** Пользователь нажимает "Подтвердить телефон" в приложении

**Акторы:** Клиент, Telegram Bot, Система

**Предусловия:**
- Пользователь авторизован через initData
- Статус верификации телефона: "REQUIRED"
- Telegram Bot активен и настроен

**Основной поток:**
1. Пользователь нажимает кнопку "Подтвердить телефон" в приложении
2. Система отправляет команду Telegram Bot
3. Telegram Bot отправляет сообщение в личные сообщения пользователя
4. Показ формы с кнопкой "Отправить номер телефона"
5. Пользователь нажимает кнопку в Telegram
6. Telegram автоматически отправляет контакт боту
7. Telegram Bot получает номер телефона
8. Бот передаёт номер в систему через webhook или API
9. Система обновляет номер телефона в профиле пользователя
10. Статус верификации телефона: "VERIFIED"
11. Уведомление пользователя об успешной верификации
12. Возврат в приложение с обновлённым статусом

**Альтернативные потоки:**
- **4a** Пользователь не нашёл сообщение → дублирование запроса с чёткими инструкциями
- **6a** Пользователь отказался от передачи контакта → альтернативный ввод номера вручную
- **8a** Telegram Bot недоступен → текстовое руководство и прямая связь с поддержкой

**Постусловия:**
- Номер телефона пользователя сохранён и верифицирован
- Статус верификации телефона обновлён
- Пользователь может продолжить работу с приложением

## 3. Верификация документов

### 3.1 Загрузка фото паспорта и прав

**Триггер:** Пользователь переходит на экран верификации документов

**Акторы:** Клиент, Система, Модератор

**Предусловия:**
- Пользователь авторизован и верифицировал телефон
- Статус верификации документов: "PENDING"
- Есть доступ к камере устройства

**Основной поток:**
1. Пользователь переходит в раздел "Верификация документов"
2. Система показывает требования к фотографиям документов
3. Пользователь фотографирует главную страницу паспорта
4. Приложение проверяет качество фото с помощью OCR preview
5. Пользователь фотографирует страницу с правами (ВУ или УДЛВ)
6. Система проводит базовую проверку качества второй фотографии
7. Подтверждение загрузки обеих фотографий
8. Система отправляет документы в очередь модерации
9. Статус документов: "PENDING_MODERATION"
10. Уведомление пользователя об отправке на модерацию
11. Информирование о сроках проверки (до 2 часов)

**Альтернативные потоки:**
- **4a** Качество фото неудовлетворительное → предложение переснять с улучшенными рекомендациями
- **5a** У пользователя нет определённых документов → предоставление списка альтернатив (загранпаспорт, военный билет)
- **9a** Ошибка обработки загрузки → сохранение черновика и возможность повторной загрузки

**Постусловия:**
- Документы загружены в систему модерации
- Пользователь ожидает результатов проверки
- Модератор получил новую задачу верификации

### 3.2 Ручная модерация документов

**Триггер:** Новые документы поступают в очередь модерации

**Акторы:** Модератор, Система

**Предусловия:**
- Документ находится в статусе "PENDING_MODERATION"
- Модератор авторизован в админ-панели
- Есть доступ к инструментам модерации документов

**Основной поток:**
1. Модератор открывает админ-панель
2. Система показывает новые документы в очереди модерации
3. Модератор выбирает документ для проверки
4. Просмотр загруженных фотографий в высоком разрешении
5. Проверка следующих критериев:
   - Читаемость текста на документах
   - Соответствие фотографии в документе внешнему облику
   - Актуальность документов (срок действия не истёк)
   - Подлинность документов (отсутствие явных признаков подделки)
6. **Если документы в порядке:**
   - Статус: "APPROVED"
   - Статус верификации пользователя: "VERIFIED"
7. **Если документы требуют доработки:**
   - Статус: "REJECTED"
   - Добавление комментария с указанием причин отклонения
   - Статус верификации пользователя: "PENDING"
8. Отправка уведомления пользователю через Telegram
9. Логирование результата модерации для аудита

**Альтернативные потоки:**
- **5a** Сомнения в подлинности документов → эскалация к старшему модератору
- **6a** Необходимы дополнительные документы → запрос дополнительных материалов от пользователя
- **8a** Ошибка отправки уведомления → повторная попытка и логирование проблемы

**Постусловия:**
- Статус документов определён (одобрено/отклонено)
- Пользователь получил уведомление о результате
- Система обновила статус верификации пользователя

## 4. Бронирование прицепа

### 4.1 Выбор времени и типа аренды

**Триггер:** Пользователь нажимает "Забронировать" на карточке прицепа

**Акторы:** Клиент, Система

**Предусловия:**
- Пользователь прошёл полную верификацию
- Прицеп доступен для бронирования
- Календарь доступности актуален

**Основной поток:**
1. Пользователь выбирает прицеп в каталоге
2. Система показывает детальную карточку прицепа
3. Пользователь нажимает "Забронировать"
4. Система проверяет статус верификации пользователя
5. Если верификация пройдена → переход к выбору времени
6. Показ календаря с доступными временными слотами
7. Пользователь выбирает дату и время начала аренды
8. Система предлагает варианты окончания аренды:
   - Почасовая аренда (минимально 2 часа)
   - Посуточная аренда
9. Пользователь выбирает тип и время окончания
10. Система рассчитывает стоимость согласно тарифам:
    - Минимальная аренда: 500₽ за 2 часа
    - Дополнительный час: 100₽
    - Сутки: 900₽
11. Показ финального расчёта с возможностью корректировки времени
12. Пользователь подтверждает бронирование

**Альтернативные потоки:**
- **4 + 5a** Верификация не завершена → переход к экрану верификации документов
- **7a** Выбранное время недоступно → предложение ближайших альтернативных слотов
- **10a** Нерабочие часы (22:00-08:00) → предложение круглосуточной аренды с доплатой
- **12a** Превышено максимальное время аренды → уведомление о лимитах и предложение других вариантов

**Постусловия:**
- Время и тип аренды выбраны
- Стоимость рассчитана согласно тарифам
- Система готова к процессу оплаты

### 4.2 Дополнительные услуги

**Триггер:** Пользователь рассматривает дополнительные опции

**Акторы:** Клиент, Система

**Предусловия:**
- Общее бронирование подтверждено
- Доступны дополнительные услуги для выбранного прицепа

**Основной поток:**
1. После подтверждения основного бронирования
2. Показ дополнительных услуг:
   - Доставка прицепа: +500₽
   - Страхование КАСКО: +200₽/день
   - Экстренная поддержка: +150₽
3. Пользователь выбирает нужные дополнительные услуги
4. Система пересчитывает итоговую стоимость
5. Показ обновлённого финального расчёта
6. Подтверждение бронирования с дополнительными услугами

**Альтернативные потоки:**
- **3a** Дополнительные услуги недоступны для выбранного времени → информирование о временных ограничениях
- **4a** Превышен бюджет пользователя → предложение оптимизации услуг или изменение параметров бронирования

**Постусловия:**
- Оптимальный набор услуг выбран
- Финальная стоимость определена
- Система готова к обработке платежа

## 5. Процесс оплаты

### 5.1 Списание аренды и HOLD депозита

**Триггер:** Пользователь подтверждает бронирование

**Акторы:** Клиент, Система, Tinkoff API

**Предусловия:**
- Бронирование полностью оформлено
- Интеграция с Tinkoff готова к работе
- У пользователя есть действующая банковская карта

**Основной поток:**
1. Пользователь нажимает "Оплатить бронирование"
2. Система перенаправляет на страницу Tinkoff
3. Ввод данных банковской карты в защищённой форме Tinkoff
4. Первый платёж: списание стоимости аренды (2 часа × 250₽ = 500₽)
5. Второй платёж: создание HOLD операции на сумму залога (5000₽)
6. **Если платежи успешны:**
   - Подтверждение бронирования
   - Статус: "CONFIRMED"
   - Генерация QR-кода для получения прицепа
7. **Если платежи неуспешны:**
   - Отклонение бронирования
   - Статус: "PAYMENT_FAILED"
   - Разрешение повторной попытки оплаты
8. Отправка подтверждения бронирования в Telegram
9. Сохранение детальной информации о транзакциях в системе

**Альтернативные потоки:**
- **5a** HOLD операция неуспешна → отменение уже проведённого платежа за аренду
- **7a** Карта заблокирована банком → предложение альтернативных способов оплаты
- **8a** Ошибка отправки уведомления → сохранение в очереди повторной отправки

**Постусловия:**
- Оплата обработана корректно
- Бронирование подтверждено или отклонено с чётким обоснованием
- Пользователь информирован о результате транзакции

## 6. Фотофиксация состояния

### 6.1 Фотофиксация до аренды

**Триггер:** Пользователь готов забрать прицеп

**Акторы:** Клиент, Система

**Предусловия:**
- Бронирование подтверждено и оплачено
- Время аренды началось
- Клиент находится рядом с прицепом

**Основной поток:**
1. Пользователь нажимает "Начать аренду" на бронировании
2. Система запрашивает разрешение на доступ к камере
3. Требование сделать минимум 4 фотографии со всех сторон прицепа:
   - Передняя часть
   - Задняя часть
   - Левая сторона
   - Правая сторона
4. Предложение сделать дополнительные фото повреждений (если есть)
5. Проверка качества фотографий системой:
   - Чёткость изображения
   - Полнота покрытия экстерьера
   - Соответствие времени и геолокации
6. Загрузка всех фотографий в систему
7. Подтверждение начала аренды
8. Статус бронирования: "IN_PROGRESS"
9. Запуск таймера аренды

**Альтернативные потоки:**
- **3a** Недостаточно качественные фотографии → повторная съёмка с рекомендациями по улучшению
- **5a** Обнаружены значительные повреждения → уведомление администратора о спорной ситуации
- **7a** Ошибка загрузки фотографий → сохранение локально с повторной попыткой загрузки

**Постусловия:**
- Состояние прицепа зафиксировано до использования
- Аренда официально начата
- Система ведёт учёт времени аренды

### 6.2 Фотофиксация после аренды

**Триггер:** Время аренды закончилось или пользователь завершает досрочно

**Акторы:** Клиент, Система, Администратор

**Предусловия:**
- Аренда находилась в статусе "IN_PROGRESS"
- Прицеп возвращён в исходное место
- Проведена базовая проверка состояния оборудования

**Основной поток:**
1. Пользователь нажимает "Завершить аренду" на активном бронировании
2. Повторный запрос на доступ к камере
3. Требование повторной фотофиксации тех же 4 сторон прицепа
4. Обязательная фиксация любых новых повреждений или изменений
5. Добавление комментариев к состоянию прицепа (при необходимости)
6. Загрузка всех итоговых фотографий в систему
7. Автоматическое сравнение "до" и "после" с базовыми алгоритмами:
   - Изменения в внешнем виде
   - Новые повреждения или царапины
   - Отсутствие или повреждение комплектующих
8. **Если урон минимальный или отсутствует:**
   - Полный возврат залогового депозита
   - Статус: "COMPLETED"
9. **Если обнаружен значительный урон:**
   - Эскалация к администратору
   - Временная блокировка возврата депозита
   - Статус: "DISPUTE_RESOLUTION"
10. Уведомление о результатах проверки состояния
11. Завершение времени аренды независимо от результатов проверки

**Альтернативные потоки:**
- **7a** Система не может автоматически определить урон → ручная модерация администратором
- **9a** Пользователь не согласен с оценкой урона → процедура апелляции с дополнительными фотографиями
- **11a** Пользователь не завершил аренду в срок → автоматическое изменение статуса и эскалация к поддержке

**Постусловия:**
- Состояние прицепа после аренды зафиксировано
- Процедура возврата залога инициирована
- Спорные случаи переданы на рассмотрение администратору
