# Story 001: Авторизация и верификация пользователей

## Scope
Реализация системы аутентификации через Telegram Mini App с серверной проверкой initData HMAC, dev-режимом без Telegram и базовым экраном профиля пользователя.

## Acceptance Criteria

### Backend (Node.js + Express)
- [ ] **HMAC валидация initData**
  - Серверная проверка подписи Telegram initData через HMAC-SHA256
  - Извлечение telegram_id, first_name, username из валидных данных
  - Генерация JWT токена для сессии пользователя
  - Обработка ошибок валидации с понятными сообщениями

- [ ] **In-memory user storage**
  - Структура UserProfile в памяти с полями: telegramId, firstName, lastName, username, phoneNumber, verificationStatus
  - Автоматическое создание нового пользователя при первом входе
  - Обновление существующих пользователей при повторном входе
  - Статусы верификации: 'PENDING', 'VERIFIED', 'REJECTED'

- [ ] **Dev-режим без Telegram**
  - Mock данные для разработки без реального Telegram WebApp
  - Переменная окружения DEV_MODE=true для активации
  - Тестовые пользователи с предустановленными данными

### Frontend (React + Telegram WebApp)
- [ ] **Telegram WebApp интеграция**
  - Инициализация Telegram WebApp API
  - Получение initData и передача на сервер
  - Обработка ошибок авторизации
  - Автоматическое перенаправление после успешной авторизации

- [ ] **Экран профиля пользователя**
  - Отображение имени пользователя из Telegram
  - Поле телефона с заглушкой "Не указан" (для будущей верификации)
  - Статус верификации с визуальными индикаторами
  - Кнопка "Выйти" для завершения сессии

- [ ] **Responsive дизайн**
  - Адаптация под различные размеры экранов Telegram
  - Использование Telegram цветовой схемы
  - Оптимизация для мобильных устройств

## Риски

### Технические риски
- **HMAC валидация может быть сложной** - риск неправильной реализации криптографической проверки
- **In-memory storage ограничения** - потеря данных при перезапуске сервера
- **Telegram API изменения** - возможные изменения в структуре initData

### Бизнес-риски
- **Безопасность данных** - риск утечки персональной информации пользователей
- **Пользовательский опыт** - сложность авторизации может отпугнуть пользователей

## Тест-кейсы

### Backend тестирование
1. **Валидация корректного initData**
   - Отправка валидного initData с правильной HMAC подписью
   - Ожидаемый результат: успешная авторизация, создание JWT токена

2. **Валидация некорректного initData**
   - Отправка initData с неправильной подписью
   - Ожидаемый результат: ошибка 401, отказ в авторизации

3. **Создание нового пользователя**
   - Первый вход с новым telegram_id
   - Ожидаемый результат: создание записи в in-memory storage

4. **Обновление существующего пользователя**
   - Повторный вход с измененными данными
   - Ожидаемый результат: обновление данных профиля

### Frontend тестирование
1. **Инициализация Telegram WebApp**
   - Открытие приложения в Telegram
   - Ожидаемый результат: корректная инициализация, получение initData

2. **Dev-режим авторизация**
   - Включение DEV_MODE и тестирование без Telegram
   - Ожидаемый результат: успешная авторизация с mock данными

3. **Отображение профиля**
   - Проверка корректности отображения данных пользователя
   - Ожидаемый результат: все поля заполнены правильно

4. **Выход из системы**
   - Нажатие кнопки "Выйти"
   - Ожидаемый результат: очистка сессии, перенаправление на экран авторизации

## Дополнительные требования

### Безопасность
- JWT токены с коротким сроком жизни (7 дней)
- Валидация всех входящих данных
- Логирование попыток авторизации

### Производительность
- Мгновенная авторизация благодаря in-memory storage
- Кэширование пользовательских данных
- Оптимизация размера JWT токенов

### Мониторинг
- Логирование успешных/неуспешных авторизаций
- Метрики времени ответа API
- Отслеживание ошибок валидации

## Definition of Done
- [ ] HMAC валидация работает корректно
- [ ] In-memory storage функционирует стабильно
- [ ] Dev-режим позволяет разработку без Telegram
- [ ] Экран профиля отображает все необходимые данные
- [ ] Все тест-кейсы пройдены успешно
- [ ] Код покрыт unit тестами
- [ ] Документация API обновлена
