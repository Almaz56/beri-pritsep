# Story 004: Интеграция платежей и система депозитов

## Scope
Интеграция с Tinkoff Payment API для обработки платежей аренды и HOLD депозитов, обработка webhooks, управление статусами платежей и sandbox-заглушки для разработки.

## Acceptance Criteria

### Backend (Tinkoff интеграция)
- [ ] **Интеграция с Tinkoff Payment API**
  - Настройка подключения к Tinkoff API
  - Создание платежей для аренды
  - Создание HOLD операций для депозитов (5000₽)
  - Обработка webhooks для обновления статусов

- [ ] **API endpoints для платежей**
  - POST /api/payments/create - создание платежа
  - POST /api/payments/hold - создание HOLD депозита
  - POST /api/payments/release - освобождение HOLD
  - GET /api/payments/:id/status - проверка статуса платежа

- [ ] **Обработка webhooks**
  - Валидация подписи webhook от Tinkoff
  - Обновление статусов платежей в in-memory storage
  - Уведомления пользователей об изменении статуса

- [ ] **Sandbox режим**
  - Переменная окружения TINKOFF_SANDBOX=true
  - Mock ответы для разработки без реальных платежей
  - Тестовые карты для проверки различных сценариев

### Frontend (React компоненты)
- [ ] **Интерфейс оплаты**
  - Отображение суммы к оплате
  - Кнопка "Оплатить" с перенаправлением на Tinkoff
  - Индикатор загрузки во время обработки платежа
  - Обработка возврата с Tinkoff (success/failure)

- [ ] **Статусы платежей**
  - Отображение текущего статуса платежа
  - Уведомления об успешной/неуспешной оплате
  - Информация о HOLD депозите

### In-memory storage
- [ ] **Структура платежей**
  ```typescript
  interface Payment {
    id: string;
    bookingId: string;
    userId: string;
    type: 'RENTAL' | 'DEPOSIT_HOLD';
    amount: number;
    status: 'PENDING' | 'PROCESSING' | 'COMPLETED' | 'FAILED' | 'CANCELLED';
    tinkoffPaymentId?: string;
    tinkoffHoldId?: string;
    createdAt: Date;
    updatedAt: Date;
  }
  ```

## Риски

### Технические риски
- **Сложность Tinkoff API** - возможные изменения в API или документации
- **Безопасность webhooks** - риск подделки webhook уведомлений
- **Потеря данных платежей** - критично при перезапуске сервера

### Бизнес-риски
- **Финансовые потери** - ошибки в обработке платежей
- **Правовые риски** - несоответствие требованиям банковского законодательства
- **Репутационные риски** - проблемы с платежами могут отпугнуть пользователей

## Тест-кейсы

### Backend тестирование
1. **Создание платежа аренды**
   - POST /api/payments/create с валидными данными
   - Ожидаемый результат: создание платежа, получение paymentId от Tinkoff

2. **Создание HOLD депозита**
   - POST /api/payments/hold с bookingId
   - Ожидаемый результат: создание HOLD операции на 5000₽

3. **Обработка webhook успешного платежа**
   - Получение webhook с status=COMPLETED
   - Ожидаемый результат: обновление статуса в in-memory storage

4. **Обработка webhook неуспешного платежа**
   - Получение webhook с status=FAILED
   - Ожидаемый результат: обновление статуса, уведомление пользователя

5. **Sandbox режим**
   - Тестирование с TINKOFF_SANDBOX=true
   - Ожидаемый результат: mock ответы без реальных платежей

### Frontend тестирование
1. **Перенаправление на Tinkoff**
   - Нажатие кнопки "Оплатить"
   - Ожидаемый результат: корректное перенаправление на форму Tinkoff

2. **Обработка успешного возврата**
   - Возврат с Tinkoff с success параметром
   - Ожидаемый результат: отображение успешного статуса

3. **Обработка неуспешного возврата**
   - Возврат с Tinkoff с error параметром
   - Ожидаемый результат: отображение ошибки, возможность повтора

4. **Отображение статусов**
   - Проверка различных статусов платежа
   - Ожидаемый результат: корректное отображение всех статусов

### Интеграционное тестирование
1. **Полный цикл платежа**
   - Создание бронирования → оплата → подтверждение
   - Ожидаемый результат: успешное завершение всего процесса

2. **Обработка HOLD депозита**
   - Создание HOLD → подтверждение → освобождение
   - Ожидаемый результат: корректная работа с депозитом

3. **Обработка ошибок**
   - Тестирование различных сценариев ошибок
   - Ожидаемый результат: корректная обработка всех ошибок

## Дополнительные требования

### Безопасность
- Валидация всех webhook уведомлений
- Шифрование чувствительных данных
- Логирование всех финансовых операций

### Мониторинг
- Отслеживание статусов платежей
- Алерты при критических ошибках
- Метрики успешности платежей

### Compliance
- Соответствие требованиям PCI DSS
- Соблюдение банковского законодательства
- Аудит всех финансовых операций

## Definition of Done
- [ ] Интеграция с Tinkoff API работает корректно
- [ ] Webhooks обрабатываются правильно
- [ ] Sandbox режим позволяет разработку без реальных платежей
- [ ] Frontend корректно отображает статусы платежей
- [ ] In-memory storage сохраняет данные платежей
- [ ] Все тест-кейсы пройдены
- [ ] Код покрыт тестами
- [ ] Документация API обновлена
- [ ] Проведено тестирование безопасности
