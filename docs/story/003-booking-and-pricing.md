# Story 003: Форма бронирования и расчет стоимости

## Scope
Реализация формы бронирования с выбором типа аренды (по часам/суткам), опцией "забор прицепа", API для расчета стоимости и создания бронирования.

## Acceptance Criteria

### Frontend (React форма бронирования)
- [ ] **Выбор типа аренды**
  - Переключатель "Почасовая" / "Посуточная"
  - Календарь для выбора даты начала аренды
  - Время начала аренды (часы:минуты)
  - Продолжительность аренды (часы для почасовой, дни для суточной)

- [ ] **Дополнительные услуги**
  - Чекбокс "Забор прицепа" (+500₽)
  - Описание услуги и условий
  - Автоматический пересчет стоимости при изменении

- [ ] **Расчет стоимости**
  - Отображение детализации цены в реальном времени
  - Разбивка: базовая стоимость + дополнительные услуги + залог
  - Валидация минимального времени аренды (2 часа)

- [ ] **Валидация формы**
  - Проверка корректности выбранных дат
  - Проверка доступности прицепа на выбранное время
  - Предупреждения о конфликтах с существующими бронированиями

### Backend (API endpoints)
- [ ] **POST /api/quote**
  - Расчет стоимости бронирования
  - Входные параметры: trailerId, startTime, endTime, rentalType, additionalServices
  - Возврат детализированной стоимости:
    ```json
    {
      "baseCost": 500,
      "additionalServices": 500,
      "deposit": 5000,
      "total": 1000,
      "breakdown": {
        "rental": "2 часа × 250₽ = 500₽",
        "pickup": "Забор прицепа = 500₽",
        "deposit": "Залог = 5000₽"
      }
    }
    ```

- [ ] **POST /api/bookings**
  - Создание нового бронирования
  - Входные параметры: trailerId, startTime, endTime, rentalType, additionalServices
  - Возврат: bookingId, статус "pending_payment", сумма к оплате
  - Сохранение в in-memory storage

### In-memory storage
- [ ] **Структура бронирования**
  ```typescript
  interface Booking {
    id: string;
    userId: string;
    trailerId: string;
    startTime: Date;
    endTime: Date;
    rentalType: 'HOURLY' | 'DAILY';
    additionalServices: {
      pickup: boolean;
    };
    pricing: {
      baseCost: number;
      additionalCost: number;
      deposit: number;
      total: number;
    };
    status: 'PENDING_PAYMENT' | 'CONFIRMED' | 'IN_PROGRESS' | 'COMPLETED';
    createdAt: Date;
  }
  ```

## Риски

### Технические риски
- **Сложность расчетов** - ошибки в формулах ценообразования
- **Конфликты бронирований** - двойное бронирование одного прицепа
- **Потеря данных** - бронирования могут потеряться при перезапуске сервера

### Бизнес-риски
- **Неправильная стоимость** - ошибки в расчетах могут привести к финансовым потерям
- **Перегрузка системы** - одновременные бронирования могут вызвать конфликты

## Тест-кейсы

### Frontend тестирование
1. **Выбор почасовой аренды**
   - Выбор 3 часов аренды
   - Ожидаемый результат: стоимость 500₽ + 100₽ = 600₽

2. **Выбор суточной аренды**
   - Выбор 1 сутки аренды
   - Ожидаемый результат: стоимость 900₽

3. **Дополнительная услуга "Забор"**
   - Включение опции "Забор прицепа"
   - Ожидаемый результат: +500₽ к общей стоимости

4. **Валидация минимального времени**
   - Выбор 1 часа аренды
   - Ожидаемый результат: ошибка "Минимальная аренда 2 часа"

5. **Проверка доступности**
   - Выбор времени, когда прицеп занят
   - Ожидаемый результат: предупреждение о недоступности

### Backend тестирование
1. **API расчета стоимости**
   - POST /api/quote с корректными данными
   - Ожидаемый результат: детализированный расчет стоимости

2. **API создания бронирования**
   - POST /api/bookings с валидными данными
   - Ожидаемый результат: создание бронирования со статусом "pending_payment"

3. **Проверка конфликтов**
   - Попытка создать бронирование на занятое время
   - Ожидаемый результат: ошибка 409 Conflict

4. **Валидация входных данных**
   - Отправка некорректных данных
   - Ожидаемый результат: ошибка 400 Bad Request

### Интеграционное тестирование
1. **Полный цикл бронирования**
   - Выбор параметров → расчет → создание бронирования
   - Ожидаемый результат: успешное создание бронирования

2. **Проверка ценообразования**
   - Различные комбинации времени и услуг
   - Ожидаемый результат: корректный расчет во всех случаях

## Дополнительные требования

### Производительность
- Кэширование расчетов стоимости
- Оптимизация запросов к API
- Debounce для пересчета стоимости

### UX
- Автосохранение формы при изменении полей
- Предупреждения о потенциальных проблемах
- Понятные сообщения об ошибках

### Безопасность
- Валидация всех входных данных
- Проверка прав пользователя на бронирование
- Логирование всех операций бронирования

## Definition of Done
- [ ] Форма бронирования работает корректно
- [ ] Расчет стоимости происходит в реальном времени
- [ ] API endpoints возвращают правильные данные
- [ ] Валидация предотвращает некорректные бронирования
- [ ] In-memory storage сохраняет бронирования
- [ ] Все тест-кейсы пройдены
- [ ] Код покрыт тестами
- [ ] Документация API обновлена
